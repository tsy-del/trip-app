<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…è¡Œéš¨èº« App | SzeYuen</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #5d2d91;
            --secondary: #e91e63;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #1c1e21;
        }
        body { font-family: -apple-system, "PingFang HK", sans-serif; background-color: var(--bg); margin: 0; padding-bottom: 70px; color: var(--text); }
        
        #view-login { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); color: white; justify-content: center; align-items: center; z-index: 5000; flex-direction: column; text-align: center; }
        #view-login input { padding: 15px; border-radius: 12px; border: none; width: 80%; max-width: 300px; margin: 10px 0; font-size: 1.1em; text-align: center; }
        #view-login button { background: var(--secondary); color: white; border: none; padding: 15px 40px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1.1em; margin-top: 10px; }

        header { background: var(--primary); color: white; padding: 20px 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
        header h1 { margin: 0; font-size: 1.2em; }
        .user-tag { position: absolute; right: 15px; top: 22px; font-size: 0.7em; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        #view-home { display: none; }
        #view-home.active { display: block; }
        .trip-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; display: flex; align-items: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .trip-icon { font-size: 2em; margin-right: 15px; }
        .trip-info { flex: 1; }
        .trip-title { font-weight: bold; }

        .add-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 15px; font-weight: bold; margin-top: 10px; }

        #view-detail { display: none; }
        #view-detail.active { display: block; }
        .back-btn { background: none; border: none; color: white; position: absolute; left: 15px; top: 20px; font-size: 1.2em; }

        nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: none; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; }
        nav.active { display: flex; }
        nav button { background: none; border: none; color: #888; font-size: 0.8em; flex: 1; }
        nav button.active { color: var(--primary); font-weight: bold; }

        .card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* è¡Œç¨‹å¡ç‰‡æ¨£å¼ */
        .timeline { position: relative; padding-left: 20px; border-left: 2px solid #eee; margin-left: 10px; }
        .day-block { margin-bottom: 30px; }
        .day-label { font-weight: bold; color: var(--primary); margin-bottom: 10px; position: relative; }
        .day-label::before { content: ''; position: absolute; left: -26px; top: 6px; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; border: 2px solid white; }
        .item-card { background: #f8f9fa; padding: 12px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .item-text { font-size: 0.95em; color: #333; }
        .map-btn { background: white; border: 1px solid #ddd; padding: 5px 10px; border-radius: 8px; font-size: 0.8em; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div id="view-login">
    <div style="font-size: 4em; margin-bottom: 20px;">âœˆï¸</div>
    <h2 style="margin-bottom: 30px;">æ—…è¡Œéš¨èº« App</h2>
    <input type="text" id="user-name" placeholder="ä½ çš„åå­—">
    <input type="password" id="access-key" placeholder="è¼¸å…¥ Token">
    <button onclick="handleLogin()">ç™»å…¥ä¸¦åŒæ­¥</button>
</div>

<header>
    <button id="btn-back" class="back-btn" onclick="showHome()" style="display:none;">â®</button>
    <h1 id="header-title">æˆ‘çš„æ—…è¡Œ</h1>
    <span id="display-user" class="user-tag" onclick="handleLogout()" style="cursor:pointer;">æœªç™»å…¥</span>
</header>

<div class="container">
    <div id="view-home">
        <div id="trip-list"></div>
        <button class="add-btn" onclick="openModal()">â• æ–°å¢æ—…è¡Œè¡Œç¨‹</button>
    </div>

    <div id="view-detail">
        <div id="tab-overview" class="tab-content active">
            <div class="card"><h2>âœˆï¸ èˆªç­è¿½è¹¤</h2><div id="flight-container">è¼‰å…¥ä¸­...</div></div>
            <div class="card"><h2>ğŸ“ˆ ç¥¨åƒ¹èµ°å‹¢</h2><div style="height:200px"><canvas id="priceChart"></canvas></div></div>
        </div>
        <div id="tab-itinerary" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin:0;">ğŸ—ºï¸ è¡Œç¨‹è¦åŠƒ</h2>
                    <div id="total-budget-tag" style="font-size: 0.8em; background: #fff3e0; color: #ff9800; padding: 4px 10px; border-radius: 20px; font-weight: bold; border: 1px solid #ffe0b2;">ç¸½é ç®—: --</div>
                    <button id="edit-btn" onclick="toggleEditItinerary()" style="background:var(--primary); color:white; border:none; padding:5px 12px; border-radius:8px;">ç·¨è¼¯</button>
                </div>
                <div id="itinerary-display" class="timeline"></div>
                <div id="itinerary-edit" style="display: none;">
                    <textarea id="itinerary-input" style="width: 100%; height: 300px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box;"></textarea>
                    <button onclick="saveItinerary()" style="width:100%; background:var(--primary); color:white; border:none; padding:12px; border-radius:10px; margin-top:10px;">å„²å­˜è¡Œç¨‹</button>
                </div>
            </div>
        </div>
    </div>
</div>

<nav id="app-nav">
    <button onclick="switchTab('overview')" id="nav-overview" class="active">ğŸ“Š<br>æ¦‚è¦½</button>
    <button onclick="switchTab('itinerary')" id="nav-itinerary">ğŸ—ºï¸<br>è¡Œç¨‹</button>
</nav>

<script>
    const DATA_REPO = 'tsy-del/japan-trip-2026';
    let GITHUB_TOKEN = localStorage.getItem('app_token');
    let currentUser = localStorage.getItem('app_user');
    let myTrips = [];
    let currentTripId = null;
    let chartInstance = null;

    function handleLogin() {
        const name = document.getElementById('user-name').value;
        const token = document.getElementById('access-key').value;
        if (name && token) {
            localStorage.setItem('app_user', name);
            localStorage.setItem('app_token', token);
            location.reload();
        }
    }

    function handleLogout() { if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) { localStorage.clear(); location.reload(); } }

    if (currentUser && GITHUB_TOKEN) {
        document.getElementById('view-login').style.display = 'none';
        document.getElementById('view-home').classList.add('active');
        document.getElementById('display-user').innerText = currentUser + ' â‡¥';
        syncFromCloud();
    }

    async function syncFromCloud() {
        try {
            const resp = await fetch(`https://api.github.com/repos/${DATA_REPO}/contents/trips.json?t=${Date.now()}`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
            });
            const file = await resp.json();
            myTrips = JSON.parse(decodeURIComponent(escape(atob(file.content))));
            renderTripList();
        } catch (e) { alert('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token'); handleLogout(); }
    }

    async function syncToCloud() {
        const getFile = await fetch(`https://api.github.com/repos/${DATA_REPO}/contents/trips.json`, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
        const file = await getFile.json();
        await fetch(`https://api.github.com/repos/${DATA_REPO}/contents/trips.json`, {
            method: 'PUT', headers: { 'Authorization': `token ${GITHUB_TOKEN}` },
            body: JSON.stringify({ message: 'Update', content: btoa(unescape(encodeURIComponent(JSON.stringify(myTrips, null, 2)))), sha: file.sha })
        });
    }

    function renderTripList() {
        const list = document.getElementById('trip-list');
        list.innerHTML = myTrips.map(t => `<div class="trip-card" onclick="showTrip('${t.id}')"><div class="trip-icon">${t.icon}</div><div class="trip-info"><div class="trip-title">${t.title}</div><span style="font-size:0.8em;color:#999">${t.status}</span></div><div>â¯</div></div>`).join('');
    }

    function showTrip(tripId) {
        currentTripId = tripId;
        const trip = myTrips.find(t => t.id === tripId);
        document.getElementById('view-home').classList.remove('active');
        document.getElementById('view-detail').classList.add('active');
        document.getElementById('app-nav').classList.add('active');
        document.getElementById('btn-back').style.display = 'block';
        document.getElementById('header-title').innerText = trip.title;
        displayItinerary(trip.itinerary);
        if(tripId === 'osaka-2026') loadOsakaData();
    }

    function displayItinerary(content) {
        const display = document.getElementById('itinerary-display');
        const lines = content.split('\n');
        let html = '';
        let totalBudget = 0;
        let dayBudget = 0;
        let dayBlocks = [];

        lines.forEach(line => {
            if (!line.trim()) return;
            
            // æå–é‡‘é¡ [æ•¸å­—]
            const moneyMatch = line.match(/\[(\d+)\]/);
            const amount = moneyMatch ? parseInt(moneyMatch[1]) : 0;
            totalBudget += amount;

            if (line.match(/æ—¥|Day/)) {
                if (dayBlocks.length > 0) {
                    // æ›´æ–°å‰ä¸€å¤©çš„é ç®—å°è¨ˆ
                    let lastBlock = dayBlocks[dayBlocks.length - 1];
                    lastBlock.html = lastBlock.html.replace('{{DAY_BUDGET}}', dayBudget > 0 ? ` (é ç®—: ${dayBudget.toLocaleString()})` : '');
                }
                dayBudget = amount;
                dayBlocks.push({
                    title: line,
                    html: `<div class="day-block"><div class="day-label">${line}<span style="font-size:0.8em; font-weight:normal; color:#ff9800;">{{DAY_BUDGET}}</span></div>`,
                    items: []
                });
            } else {
                dayBudget += amount;
                const cleanLine = line.replace(/\[\d+\]/, '').replace(/^[-\*\sğŸ›«ğŸ¨ğŸœğŸ›ï¸ğŸ›¬]+/, '').trim();
                const itemHtml = `<div class="item-card">
                    <span class="item-text">${line}</span>
                    <button class="map-btn" onclick="openMap('${cleanLine}')">ğŸ“ åœ°åœ–</button>
                </div>`;
                if (dayBlocks.length > 0) {
                    dayBlocks[dayBlocks.length - 1].html += itemHtml;
                } else {
                    // å¦‚æœç¬¬ä¸€è¡Œä¸æ˜¯æ—¥æœŸï¼Œç›´æ¥åŠ é€²å»
                    html += itemHtml;
                }
            }
        });

        // è™•ç†æœ€å¾Œä¸€å¤©çš„å°è¨ˆ
        if (dayBlocks.length > 0) {
            let lastBlock = dayBlocks[dayBlocks.length - 1];
            lastBlock.html = lastBlock.html.replace('{{DAY_BUDGET}}', dayBudget > 0 ? ` (é ç®—: ${dayBudget.toLocaleString()})` : '');
            dayBlocks.forEach(block => html += block.html + '</div>');
        }

        display.innerHTML = html || '<p style="color:#999; text-align:center;">å°šç„¡è¡Œç¨‹</p>';
        document.getElementById('itinerary-input').value = content;
        document.getElementById('total-budget-tag').innerText = `ç¸½é ç®—: ${totalBudget.toLocaleString()}`;
    }

    function openMap(query) {
        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
    }

    function toggleEditItinerary() {
        const d = document.getElementById('itinerary-display'), e = document.getElementById('itinerary-edit'), b = document.getElementById('edit-btn');
        const isE = e.style.display === 'none';
        e.style.display = isE ? 'block' : 'none'; d.style.display = isE ? 'none' : 'block';
        b.innerText = isE ? 'å–æ¶ˆ' : 'ç·¨è¼¯';
    }

    function saveItinerary() {
        const idx = myTrips.findIndex(t => t.id === currentTripId);
        myTrips[idx].itinerary = document.getElementById('itinerary-input').value;
        displayItinerary(myTrips[idx].itinerary); toggleEditItinerary(); syncToCloud();
    }

    function showHome() { location.reload(); }
    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.getElementById('nav-' + id).classList.add('active');
    }

    async function loadOsakaData() {
        const resp = await fetch('data.json');
        const data = await resp.json();
        const latest = data[data.length - 1];
        document.getElementById('flight-container').innerHTML = `<div style="display:flex;justify-content:space-between"><div>HKGâ”KIX<br><small>UO686</small></div><div style="color:var(--secondary);font-weight:bold">HK$ ${latest.uo686}</div></div>`;
    }
</script>
</body>
</html>
