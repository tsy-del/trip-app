<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…è¡Œéš¨èº« App | SzeYuen</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #5d2d91;
            --secondary: #e91e63;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #1c1e21;
        }
        body { font-family: -apple-system, "PingFang HK", sans-serif; background-color: var(--bg); margin: 0; padding-bottom: 70px; color: var(--text); }
        
        /* Login View */
        #view-login { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); color: white; justify-content: center; align-items: center; z-index: 5000; flex-direction: column; text-align: center; }
        #view-login input { padding: 15px; border-radius: 12px; border: none; width: 80%; max-width: 300px; margin: 10px 0; font-size: 1.1em; text-align: center; }
        #view-login button { background: var(--secondary); color: white; border: none; padding: 15px 40px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1.1em; margin-top: 10px; }

        header { background: var(--primary); color: white; padding: 20px 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
        header h1 { margin: 0; font-size: 1.2em; }
        .user-tag { position: absolute; right: 15px; top: 22px; font-size: 0.7em; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        /* Trip List View */
        #view-home { display: none; }
        #view-home.active { display: block; }
        .trip-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; display: flex; align-items: center; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .trip-card:active { transform: scale(0.98); }
        .trip-icon { font-size: 2em; margin-right: 15px; }
        .trip-info { flex: 1; }
        .trip-title { font-weight: bold; font-size: 1.1em; margin-bottom: 4px; }
        .trip-status { font-size: 0.8em; color: var(--primary); background: #eee; padding: 2px 8px; border-radius: 10px; }

        .add-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 15px; font-weight: bold; margin-top: 10px; cursor: pointer; }

        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; }
        .modal-content h3 { margin-top: 0; color: var(--primary); }
        .modal-content input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1em; color: #333; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btns button { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-confirm { background: var(--primary); color: white; }
        .btn-cancel { background: #eee; }

        /* Trip Detail View */
        #view-detail { display: none; }
        #view-detail.active { display: block; }
        .back-btn { background: none; border: none; color: white; position: absolute; left: 15px; top: 20px; font-size: 1.2em; cursor: pointer; }

        nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: none; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; }
        nav.active { display: flex; }
        nav button { background: none; border: none; color: #888; font-size: 0.8em; display: flex; flex-direction: column; align-items: center; flex: 1; }
        nav button.active { color: var(--primary); font-weight: bold; }

        .card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .flight-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .price { font-weight: bold; color: var(--secondary); font-size: 1.2em; }
        .timeline { position: relative; padding-left: 20px; border-left: 2px solid #ddd; }
        .day { margin-bottom: 20px; }
        .day-date { font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<!-- Login View -->
<div id="view-login">
    <div style="font-size: 4em; margin-bottom: 20px;">âœˆï¸</div>
    <h2 style="margin-bottom: 30px;">æ—…è¡Œéš¨èº« App</h2>
    <input type="text" id="user-name" placeholder="ä½ çš„åå­—">
    <input type="password" id="access-key" placeholder="è¼¸å…¥ Token">
    <p style="font-size: 0.7em; color: rgba(255,255,255,0.7); width: 80%; margin-top: -5px;">* è«‹è¼¸å…¥ GitHub Token ä»¥é–‹å•Ÿé›²ç«¯åŒæ­¥</p>
    <button onclick="handleLogin()">ç™»å…¥ä¸¦åŒæ­¥</button>
</div>

<header>
    <button id="btn-back" class="back-btn" onclick="showHome()" style="display:none;">â®</button>
    <h1 id="header-title">æˆ‘çš„æ—…è¡Œ</h1>
    <span id="display-user" class="user-tag" onclick="handleLogout()" style="cursor:pointer;">æœªç™»å…¥</span>
</header>

<div class="container">
    <div id="view-home">
        <div id="trip-list"></div>
        <button class="add-btn" onclick="openModal()">â• æ–°å¢æ—…è¡Œè¡Œç¨‹</button>
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸŒ é–‹å±•æ–°æ—…ç¨‹</h3>
            <input type="text" id="new-trip-title" placeholder="ä¾‹å¦‚ï¼š2026 æ±äº¬ä¹‹æ—…">
            <input type="text" id="new-trip-icon" placeholder="é¸æ“‡ Emoji (ä¾‹å¦‚ï¼šğŸ—¼)" value="âœˆï¸">
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="addNewTrip()">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <div id="view-detail">
        <div id="tab-overview" class="tab-content active">
            <div class="card">
                <h2>âœˆï¸ èˆªç­è¿½è¹¤</h2>
                <div id="flight-container">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="card">
                <h2>ğŸ“ˆ ç¥¨åƒ¹èµ°å‹¢</h2>
                <div style="height:200px"><canvas id="priceChart"></canvas></div>
            </div>
        </div>
        <div id="tab-itinerary" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px;">
                    <h2 style="margin:0; border:none;">ğŸ—ºï¸ è¡Œç¨‹è¦åŠƒ</h2>
                    <button id="edit-btn" onclick="toggleEditItinerary()" style="background: var(--primary); color: white; border: none; padding: 5px 12px; border-radius: 8px; font-size: 0.8em;">ç·¨è¼¯</button>
                </div>
                <div id="itinerary-display" class="timeline"></div>
                <div id="itinerary-edit" style="display: none;">
                    <textarea id="itinerary-input" style="width: 100%; height: 300px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit; box-sizing: border-box;"></textarea>
                    <button onclick="saveItinerary()" style="width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; margin-top: 10px; font-weight: bold;">å„²å­˜è¡Œç¨‹</button>
                </div>
            </div>
        </div>
        <div id="tab-budget" class="tab-content">
            <div class="card"><h2>ğŸ’° é–‹æ”¯è¨˜éŒ„</h2><p>å³å°‡æ¨å‡º...</p></div>
        </div>
    </div>
</div>

<nav id="app-nav">
    <button onclick="switchTab('overview')" id="nav-overview" class="active"><span>ğŸ“Š</span><br>æ¦‚è¦½</button>
    <button onclick="switchTab('itinerary')" id="nav-itinerary"><span>ğŸ—ºï¸</span><br>è¡Œç¨‹</button>
    <button onclick="switchTab('budget')" id="nav-budget"><span>ğŸ’°</span><br>é ç®—</button>
</nav>

<script>
    const DATA_REPO = 'tsy-del/japan-trip-2026';
    let GITHUB_TOKEN = localStorage.getItem('app_token');
    let currentUser = localStorage.getItem('app_user');
    let chartInstance = null;
    let currentTripId = null;
    let myTrips = [];

    function handleLogin() {
        const name = document.getElementById('user-name').value;
        const token = document.getElementById('access-key').value;
        if (name && token) {
            localStorage.setItem('app_user', name);
            localStorage.setItem('app_token', token);
            currentUser = name;
            GITHUB_TOKEN = token;
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-home').classList.add('active');
            document.getElementById('display-user').innerText = name + ' â‡¥';
            syncFromCloud();
        } else {
            alert('è«‹è¼¸å…¥åå­—å’Œ Tokenï¼');
        }
    }

    function handleLogout() {
        if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
            localStorage.removeItem('app_user');
            localStorage.removeItem('app_token');
            location.reload();
        }
    }

    if (currentUser && GITHUB_TOKEN) {
        document.getElementById('view-login').style.display = 'none';
        document.getElementById('view-home').classList.add('active');
        document.getElementById('display-user').innerText = currentUser + ' â‡¥';
        syncFromCloud();
    }

    async function syncFromCloud() {
        const listContainer = document.getElementById('trip-list');
        listContainer.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">æ­£åœ¨å¾é›²ç«¯åŒæ­¥è¡Œç¨‹...</p>';
        try {
            const resp = await fetch(`https://api.github.com/repos/${DATA_REPO}/contents/trips.json?t=${Date.now()}`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
            });
            if (!resp.ok) throw new Error('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æ¬Šé™');
            const file = await resp.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            myTrips = JSON.parse(content);
            renderTripList();
        } catch (e) {
            alert(e.message);
            handleLogout();
        }
    }

    async function syncToCloud() {
        try {
            const getFileResp = await fetch(`https://api.github.com/repos/${DATA_REPO}/contents/trips.json`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            const file = await getFileResp.json();
            const newContent = btoa(unescape(encodeURIComponent(JSON.stringify(myTrips, null, 2))));
            await fetch(`https://api.github.com/repos/${DATA_REPO}/contents/trips.json`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Update by ${currentUser}`, content: newContent, sha: file.sha })
            });
        } catch (e) { alert('ä¸Šå‚³å¤±æ•—ï¼š' + e.message); }
    }

    function renderTripList() {
        const listContainer = document.getElementById('trip-list');
        listContainer.innerHTML = '';
        myTrips.forEach(trip => {
            const card = document.createElement('div');
            card.className = 'trip-card';
            card.onclick = () => showTrip(trip.id);
            card.innerHTML = `<div class="trip-icon">${trip.icon}</div><div class="trip-info"><div class="trip-title">${trip.title}</div><span class="trip-status">${trip.status}</span></div><div>â¯</div>`;
            listContainer.appendChild(card);
        });
    }

    function openModal() { document.getElementById('add-modal').classList.add('active'); }
    function closeModal() { document.getElementById('add-modal').classList.remove('active'); }

    function addNewTrip() {
        const title = document.getElementById('new-trip-title').value;
        const icon = document.getElementById('new-trip-icon').value;
        if (!title) return alert('è«‹è¼¸å…¥è¡Œç¨‹åç¨±');
        const newTrip = { id: 'trip-' + Date.now(), title, icon, status: 'è¦åŠƒä¸­', itinerary: 'ç¬¬ä¸€æ—¥\nåœ¨æ­¤è¼¸å…¥è¡Œç¨‹...' };
        myTrips.push(newTrip);
        renderTripList(); closeModal(); showTrip(newTrip.id);
        syncToCloud();
    }

    function showTrip(tripId) {
        currentTripId = tripId;
        const trip = myTrips.find(t => t.id === tripId);
        if (!trip) return;
        document.getElementById('view-home').classList.remove('active');
        document.getElementById('view-detail').classList.add('active');
        document.getElementById('app-nav').classList.add('active');
        document.getElementById('btn-back').style.display = 'block';
        document.getElementById('header-title').innerText = trip.title;
        displayItinerary(trip.itinerary);
        if(tripId === 'osaka-2026') loadOsakaData();
        else {
            document.getElementById('flight-container').innerHTML = '<p style="color:#999">æš«ç„¡èˆªç­è³‡æ–™</p>';
            if(chartInstance) chartInstance.destroy();
        }
    }

    function showHome() {
        document.getElementById('view-home').classList.add('active');
        document.getElementById('view-detail').classList.remove('active');
        document.getElementById('app-nav').classList.remove('active');
        document.getElementById('btn-back').style.display = 'none';
        document.getElementById('header-title').innerText = 'æˆ‘çš„æ—…è¡Œ';
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        document.getElementById('nav-' + tabId).classList.add('active');
    }

    function displayItinerary(content) {
        const display = document.getElementById('itinerary-display');
        display.innerHTML = content.split('\n').map(line => line.match(/æ—¥|Day/) ? `<div class="day"><div class="day-date">${line}</div>` : `<div>${line}</div>`).join('') || 'å°šç„¡å…§å®¹';
        document.getElementById('itinerary-input').value = content;
    }

    function toggleEditItinerary() {
        const display = document.getElementById('itinerary-display'), edit = document.getElementById('itinerary-edit'), btn = document.getElementById('edit-btn');
        const isEdit = edit.style.display === 'none';
        edit.style.display = isEdit ? 'block' : 'none';
        display.style.display = isEdit ? 'none' : 'block';
        btn.innerText = isEdit ? 'å–æ¶ˆ' : 'ç·¨è¼¯';
    }

    function saveItinerary() {
        const content = document.getElementById('itinerary-input').value;
        const idx = myTrips.findIndex(t => t.id === currentTripId);
        if (idx > -1) {
            myTrips[idx].itinerary = content;
            displayItinerary(content); toggleEditItinerary();
            syncToCloud();
        }
    }

    async function loadOsakaData() {
        try {
            const response = await fetch('data.json?t=' + new Date().getTime());
            const data = await response.json();
            const latest = data[data.length - 1];
            document.getElementById('flight-container').innerHTML = `<div class="flight-row"><div><strong>é¦™æ¸¯ â” å¤§é˜ª</strong><br><small>UO686 | 7/18 08:45</small></div><div class="price">HK$ ${latest.uo686}</div></div><div class="flight-row"><div><strong>å¤§é˜ª â” é¦™æ¸¯</strong><br><small>UO899 | 7/26 17:00</small></div><div class="price">HK$ ${latest.uo899}</div></div>`;
            const ctx = document.getElementById('priceChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: data.map(d => d.date.split(' ')[0]), datasets: [{ label: 'ç¥¨åƒ¹', data: data.map(d => d.total), borderColor: '#5d2d91', fill: true }] }, options: { responsive: true, maintainAspectRatio: false } });
        } catch (e) { console.error(e); }
    }
</script>
</body>
</html>
